'use strict'

const { axiosAdapter } = require("../lib/axiosAdapter");
var guilder = require("./guilder.class");

const HARDCODE = 'https://securepubads.g.doubleclick.net/gampad/adx?iu=6062/guilder_test/native_test&sz=1234x1234&native_version=3&native_templates=1&cmrv=1&cmrids=1234567!7887603&url=www.martvanburen.com&ss_req=1&ip=168.212.226.204&debug_experiment_id=44736864&adtest=on'
const HARDCODE2 = 'https://securepubads.g.doubleclick.net/gampad/adx?iu=6062/guilder_test/native_test&sz=1234x1234&native_version=3&native_templates=1&cmrv=1&cmrids=78876003!54083587!80830703!79579616!79622447!79579082!78649491!79622565!81497742!81083216!54083594!79622618!80944171!54083590!80787208!79687049!78649582!79578089!81083060!81497738!80315024!80555687!78261474!81083215!80315144!79622856!53469563!79578087!80315121!78261468!79622478!81083084!51314019!80944169!78649495!79622611!80555682!80944177!79622572!80315115!79622479!78261475!80315026!78649572!79622621!80944176!78261471!53469554!78062355!79622466!80830704!79687052!79579081!80315120!78261473!78649494!80315141!78649576!78862326!78649573!80555681!54083595!80555689!79622617!81083085!78862325!78649580!81083057!79687047!79579079!80317095!77754266!79622455!80944183!77418683!79578006!80787209!79579615!54083605!78649492!80944173!78261469!80315135!78261470!80944172!81497752!76473859!79622858!79622848!80315137!80315143!79687050!78649581!81083214!80830702!79687051!79387538!80315122!81485633!78876000!80315119!81497740!79578007!77754264!80944182!80830685!80555690!80317096!80315025!80317073!79387528!81083217!78649579!77754261!79387527!79622571!79622448!77754258!78649575!80317097!80315114!77418682!80944135!77754260!80555684!80944178!79387534!53469564!80555686!81083218!78261467!78875998!80555676!79622575!81497727!77754263!78649577!79622566!79578090!79622470!80830682!80944137!79579613!80317098!79622476!80830680!79622851!78649578!77754257!81083058&url=www.google.com&ss_req=1&ip=168.212.226.204&debug_experiment_id=44741674&adtest=on&ss_req=1'
const HARDCODE3 = 'https://securepubads.g.doubleclick.net/gampad/adx?iu=6062/guilder_test/native_test&sz=1234x1234&native_version=3&native_templates=1&cmrv=1&url=www.google.com&ss_req=1&ip=168.212.226.204&adtest=on&jrv=1&num_ads=3&c=613794489&ptt=19&cmrids=78876003!54083587!80830703!79579616!79622447!79579082!78649491!79622565!81497742!81083216!54083594!79622618!80944171!54083590!80787208!79687049!78649582!79578089!81083060!81497738!80315024!80555687!78261474!81083215!80315144!79622856!53469563!79578087!80315121!78261468!79622478!81083084!51314019!80944169!78649495!79622611!80555682!80944177!79622572!80315115!79622479!78261475!80315026!78649572!79622621!80944176!78261471!53469554!78062355!79622466!80830704!79687052!79579081!80315120!78261473!78649494!80315141!78649576!78862326!78649573!80555681!54083595!80555689!79622617!81083085!78862325!78649580!81083057!79687047!79579079!80317095!77754266!79622455!80944183!77418683!79578006!80787209!79579615!54083605!78649492!80944173!78261469!80315135!78261470!80944172!81497752!76473859!79622858!79622848!80315137!80315143!79687050!78649581!81083214!80830702!79687051!79387538!80315122!81485633!78876000!80315119!81497740!79578007!77754264!80944182!80830685!80555690!80317096!80315025!80317073!79387528!81083217!78649579!77754261!79387527!79622571!79622448!77754258!78649575!80317097!80315114!77418682!80944135!77754260!80555684!80944178!79387534!53469564!80555686!81083218!78261467!78875998!80555676!79622575!81497727!77754263!78649577!79622566!79578090!79622470!80830682!80944137!79579613!80317098!79622476!80830680!79622851!78649578!77754257!81083058'
const HARDCODE4 = 'https://securepubads.g.doubleclick.net/gampad/adx?iu=6062/guilder_test/native_test&sz=1234x1234&native_version=3&native_templates=1&cmrv=1&url=www.google.com&ss_req=1&ip=168.212.226.204&adtest=on&jrv=1&num_ads=3&c=951454833&ptt=19&cmrq=shirt'

async function requestAd(req, res, next) {
  var params = {
    iu: '/6062/guilder_test/native_test',
    sz: '1234x1234',
    cmrq: 'shirt',
    url: 'www.google.com'
  }

  var ad_request = new guilder.Request(req, params)
  var ad_url = ad_request.get_url()
  console.log('constructed url: %s', ad_url)

  const axiosConfig = {
    method: "GET",
    url: ad_url,
  };

  try {
    let result = await axiosAdapter(axiosConfig);
    console.log(axiosConfig);
    console.log(result);

    var ad_response = new guilder.Response(result);
    ad_response.parse();

    var ad_renderer = new guilder.Renderer(res);
    ad_renderer.set_response_values(ad_response.ads[0]);

    next();
  } catch (error) {
    console.log(error);
  }

}

module.exports = { requestAd }